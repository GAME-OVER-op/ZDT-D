<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Резервное копирование / Восстановление</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Светлая тема */
            --primary: #5e35b1;
            --primary-light: #7e57c2;
            --primary-dark: #4527a0;
            --secondary: #26a69a;
            --success: #43a047;
            --error: #e53935;
            --warning: #ff9800;
            --surface: #ffffff;
            --background: #f5f7fa;
            --text-primary: #333333;
            --text-secondary: #666666;
            --nav-bg: #ffffff;
            --card-bg: #ffffff;
            --info-box-bg: rgba(94, 53, 177, 0.05);
            --info-box-border: var(--primary);
            --footer-text: var(--text-secondary);
        }

        [data-theme="dark"] {
            /* Темная тема */
            --primary: #7e57c2;
            --primary-light: #9575cd;
            --primary-dark: #654ea3;
            --secondary: #26a69a;
            --success: #66bb6a;
            --error: #ef5350;
            --warning: #ffa726;
            --surface: #1e1e1e;
            --background: #121212;
            --text-primary: #e0e0e0;
            --text-secondary: #9e9e9e;
            --nav-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --info-box-bg: rgba(126, 87, 194, 0.15);
            --info-box-border: var(--primary);
            --footer-text: #9e9e9e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        body {
            background: var(--background);
            min-height: 100vh;
            font-family: 'Roboto', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        header {
            text-align: center;
            padding: 30px 20px 20px;
            position: relative;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 5px 15px rgba(94, 53, 177, 0.3);
        }
        
        .logo i {
            font-size: 40px;
            color: white;
        }
        
        h1 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        nav {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            background: var(--nav-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 15px 10px;
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .nav-item i {
            margin-bottom: 5px;
            font-size: 20px;
            transition: color 0.3s ease;
        }
        
        .nav-item.active, .nav-item:hover {
            background: var(--primary);
            color: white;
        }
        
        .nav-item.active i, .nav-item:hover i {
            color: white;
        }
        
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        
        .backup-card {
            flex: 1;
            min-width: 300px;
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(94, 53, 177, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .backup-card:hover {
            transform: translateY(-5px);
        }
        
        .card-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .card-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: var(--primary-dark);
        }
        
        .card-desc {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .main-button {
            transition: all 0.3s ease;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            padding: 16px 32px;
            font-size: 1.1rem;
            border-radius: 50px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .main-button.blue {
            background: var(--primary);
            color: white;
        }
        
        .main-button.green {
            background: var(--success);
            color: white;
        }
        
        .main-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0, 0, 0, 0.15);
        }
        
        .main-button:active {
            transform: translateY(1px);
        }
        
        .main-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .info-box {
            background: var(--info-box-bg);
            border-radius: 12px;
            padding: 15px;
            margin-top: 30px;
            border-left: 4px solid var(--info-box-border);
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        
        .info-box i {
            color: var(--primary);
            vertical-align: middle;
            margin-right: 8px;
            font-size: 20px;
        }
        
        .spinner {
            animation: spin 1.5s linear infinite;
        }
        
        .theme-switcher {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        
        .theme-switcher i {
            font-size: 24px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .backup-card {
                padding: 20px 15px;
            }
            
            .main-button {
                padding: 14px 24px;
                font-size: 1rem;
            }
            
            .nav-item {
                padding: 12px 5px;
                font-size: 0.9rem;
            }
            
            .nav-item i {
                font-size: 18px;
            }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--footer-text);
            font-size: 0.9rem;
            margin-top: 30px;
        }
    </style>
    <script type="module">
        import { exec, toast } from '/kernelsu.js';

        // Определение языка
        const lang = navigator.language.startsWith('ru') ? 'ru' : 'en';
        
        // Локализация
        const L = {
            ru: {
                title: 'Резервное копирование / Восстановление',
                btn_backup: 'Сделать бэкап',
                btn_restore: 'Восстановить из бэкапа',
                msg_success_bk: 'Бэкап успешно сохранён в «%s».',
                msg_no_read: 'Не удалось прочитать «%s».',
                msg_json_err: 'Ошибка кодирования JSON.',
                msg_save_err: 'Не удалось сохранить бэкап в «%s».',
                msg_no_backup: 'Файлы бэкапа не найдены в «%s».',
                msg_json_parse: 'Не удалось разобрать JSON из «%s».',
                msg_success_rs: 'Восстановление из «%s» прошло успешно.',
                msg_fail_file: 'Не удалось восстановить «%s».',
                backup_desc: 'Создайте резервную копию всех настроек и конфигураций',
                restore_desc: 'Восстановите настройки из последней созданной резервной копии',
                path_info: 'Файлы бэкапа сохраняются в /storage/emulated/0/',
                jq_error: 'jq не установлен. Установите jq и повторите.',
                file_not_found: 'Файл не найден: %s'
            },
            en: {
                title: 'Backup / Restore',
                btn_backup: 'Make Backup',
                btn_restore: 'Restore from Backup',
                msg_success_bk: 'Backup successfully saved to "%s".',
                msg_no_read: 'Failed to read "%s".',
                msg_json_err: 'JSON encoding error.',
                msg_save_err: 'Failed to save backup to "%s".',
                msg_no_backup: 'No backup files found in "%s".',
                msg_json_parse: 'Failed to parse JSON from "%s".',
                msg_success_rs: 'Restore from "%s" completed successfully.',
                msg_fail_file: 'Failed to restore "%s".',
                backup_desc: 'Create a backup of all settings and configurations',
                restore_desc: 'Restore settings from the last created backup',
                path_info: 'Backup files are saved in /storage/emulated/0/',
                jq_error: 'jq is not installed. Please install jq and try again.',
                file_not_found: 'File not found: %s'
            }
        }[lang];
        
        // Список файлов для бэкапа
        const files = [
            'bye_dpi', 'ciadpi.conf', 'config0', 'config1',
            'ip_ranges3.txt', 'ip_ranges4.txt', 'uid_program0',
            'uid_program1', 'zapret_config0', 'zapret_config1',
            'zapret_config2', 'zapret_config3', 'zapret_config4',
            'zapret_uid0', 'zapret_uid1', 'zapret_uid2',
            'zapret_uid3', 'zapret_uid4', 'zapret_uid5',
            // Добавляем zapret_mobile0…zapret_mobile5
            'zapret_mobile0', 'zapret_mobile1', 'zapret_mobile2',
            'zapret_mobile3', 'zapret_mobile4', 'zapret_mobile5',
            // Добавляем zapret_wifi0…zapret_wifi5
            'zapret_wifi0', 'zapret_wifi1', 'zapret_wifi2',
            'zapret_wifi3', 'zapret_wifi4', 'zapret_wifi5'
        ];
        
        // Пути
        const baseDir = '/data/adb/modules/ZDT-D/working_folder';
        const backupDir = '/storage/emulated/0';
        const prefix = 'ZDT_backup_';
        const pattern = `${backupDir}/${prefix}*.json`;

        // Элементы интерфейса
        let backupBtn, restoreBtn;

        // Проверка существования файла
        async function fileExists(path) {
            try {
                await exec(`test -f '${path}'`);
                return true;
            } catch (e) {
                return false;
            }
        }

        // Проверка наличия jq
        async function checkJq() {
            try {
                await exec('command -v jq');
                return true;
            } catch (e) {
                toast(L.jq_error);
                return false;
            }
        }

        // Создание бэкапа с использованием jq
        async function createBackup() {
            if (!await checkJq()) return;
            
            backupBtn.disabled = true;
            const originalHTML = backupBtn.innerHTML;
            backupBtn.innerHTML = `<div class="spinner"><i class="material-icons">sync</i></div> ${L.btn_backup}...`;
            
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const fileName = `${prefix}${timestamp}.json`;
                const fullPath = `${backupDir}/${fileName}`;

                // Создаем временный файл
                const tmpFile = `/data/local/tmp/zdt_backup_${Date.now()}.json`;
                await exec(`echo '{}' > '${tmpFile}'`);

                for (const file of files) {
                    const path = `${baseDir}/${file}`;
                    try {
                        if (await fileExists(path)) {
                            await exec(`jq --rawfile content '${path}' --arg name '${file}' '. + {(\$name): \$content}' '${tmpFile}' > '${tmpFile}.new'`);
                        } else {
                            await exec(`jq --arg name '${file}' '. + {(\$name): null}' '${tmpFile}' > '${tmpFile}.new'`);
                            toast(L.file_not_found.replace('%s', path));
                        }
                        await exec(`mv '${tmpFile}.new' '${tmpFile}'`);
                    } catch (e) {
                        console.error(`Error processing ${file}:`, e);
                        await exec(`jq --arg name '${file}' '. + {(\$name): null}' '${tmpFile}' > '${tmpFile}.new'`);
                        await exec(`mv '${tmpFile}.new' '${tmpFile}'`);
                    }
                }

                // Перемещаем временный файл в итоговый путь
                await exec(`mv '${tmpFile}' '${fullPath}'`);
                toast(L.msg_success_bk.replace('%s', fileName));
            } catch (error) {
                console.error("Backup error:", error);
                toast(L.msg_save_err.replace('%s', fileName) || error.message);
            } finally {
                backupBtn.innerHTML = originalHTML;
                backupBtn.disabled = false;
            }
        }

        // Восстановление из бэкапа с использованием jq
        async function restoreBackup() {
            if (!await checkJq()) return;
            
            restoreBtn.disabled = true;
            const originalHTML = restoreBtn.innerHTML;
            restoreBtn.innerHTML = `<div class="spinner"><i class="material-icons">sync</i></div> ${L.btn_restore}...`;
            
            try {
                // Поиск последнего бэкапа (как в shell-скрипте)
                const { stdout } = await exec(`find "${backupDir}" -maxdepth 1 -type f -name "${prefix}*.json" -printf '%T@ %p\\n' 2>/dev/null | sort -nr | head -n1 | cut -d' ' -f2-`);
                const latestBackup = stdout.trim();
                
                if (!latestBackup) {
                    toast(L.msg_no_backup.replace('%s', backupDir));
                    return;
                }
                
                // Восстановление файлов
                let errors = false;
                for (const file of files) {
                    const path = `${baseDir}/${file}`;
                    try {
                        // Извлекаем содержимое файла из JSON и записываем в целевой файл
                        await exec(`jq -r --arg name '${file}' '.[$name] // empty' '${latestBackup}' > '${path}'`);
                    } catch (e) {
                        console.error(`Error restoring ${file}:`, e);
                        toast(L.msg_fail_file.replace('%s', file));
                        errors = true;
                    }
                }
                
                if (!errors) {
                    toast(L.msg_success_rs.replace('%s', latestBackup.split('/').pop()));
                    // Перезагрузка сервиса после восстановления
                    try {
                        await exec('zapret restart');
                        toast('Служба zapret перезапущена');
                    } catch (e) {
                        console.error('Restart error:', e);
                        toast('Ошибка перезапуска службы');
                    }
                }
            } catch (error) {
                console.error("Restore error:", error);
                toast(error.message || 'Restoration failed');
            } finally {
                restoreBtn.innerHTML = originalHTML;
                restoreBtn.disabled = false;
            }
        }

        // Инициализация темы
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Приоритет: сохраненная тема > системная настройка
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else if (systemPrefersDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        // Переключение темы
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Обновление иконки
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = newTheme === 'dark' ? 'light_mode' : 'dark_mode';
        }

        // Инициализация страницы
        document.addEventListener("DOMContentLoaded", () => {
            // Инициализация темы
            initTheme();
            
            // Обновление текстов
            document.title = L.title;
            document.querySelector('h1').textContent = L.title;
            document.querySelector('.backup-title').textContent = L.btn_backup;
            document.querySelector('.restore-title').textContent = L.btn_restore;
            document.querySelector('.backup-desc').textContent = L.backup_desc;
            document.querySelector('.restore-desc').textContent = L.restore_desc;
            document.querySelector('.path-info').innerHTML = `<i class="material-icons">info</i> ${L.path_info}`;
            
            // Настройка кнопок
            backupBtn = document.getElementById('backupBtn');
            restoreBtn = document.getElementById('restoreBtn');
            
            backupBtn.innerHTML = `<i class="material-icons">save</i> ${L.btn_backup}`;
            restoreBtn.innerHTML = `<i class="material-icons">restore</i> ${L.btn_restore}`;
            
            backupBtn.addEventListener('click', createBackup);
            restoreBtn.addEventListener('click', restoreBackup);
            
            // Настройка переключателя темы
            const themeSwitch = document.getElementById('themeSwitch');
            themeSwitch.addEventListener('click', toggleTheme);
            
            // Установка правильной иконки для темы
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = currentTheme === 'dark' ? 'light_mode' : 'dark_mode';
        });
    </script>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="material-icons">backup</i>
            </div>
            <h1>Резервное копирование / Восстановление</h1>
            <div class="subtitle">Управление резервными копиями конфигураций</div>
        </header>
        
        <nav>
            <a href="index.html" class="nav-item">
                <i class="material-icons">info</i>
                <span>Состояние</span>
            </a>
            <a href="domains.html" class="nav-item">
                <i class="material-icons">domain</i>
                <span>Домены</span>
            </a>
            <a href="config.html" class="nav-item">
                <i class="material-icons">build</i>
                <span>Конфиг</span>
            </a>
            <a href="check.html" class="nav-item">
                <i class="material-icons">monitoring</i>
                <span>Мониторинг</span>
            </a>
            <a href="backup.html" class="nav-item active">
                <i class="material-icons">backup</i>
                <span>Бэкап</span>
            </a>
        </nav>
        
        <div class="cards-container">
            <div class="backup-card">
                <div class="card-icon">
                    <i class="material-icons">save</i>
                </div>
                <h2 class="card-title backup-title">Сделать бэкап</h2>
                <p class="card-desc backup-desc">
                    Создайте резервную копию всех настроек и конфигураций
                </p>
                <button id="backupBtn" class="main-button blue">
                    <i class="material-icons">save</i> Сделать бэкап
                </button>
            </div>
            
            <div class="backup-card">
                <div class="card-icon">
                    <i class="material-icons">restore</i>
                </div>
                <h2 class="card-title restore-title">Восстановить</h2>
                <p class="card-desc restore-desc">
                    Восстановите настройки из последней резервной копии
                </p>
                <button id="restoreBtn" class="main-button green">
                    <i class="material-icons">restore</i> Восстановить
                </button>
            </div>
        </div>
        
        <div class="info-box path-info">
            <i class="material-icons">info</i>
            Файлы бэкапа сохраняются в /storage/emulated/0/
        </div>
        
        <footer>
            Zapret Control Panel &copy; 2023
        </footer>
    </div>
    
    <!-- Переключатель темы -->
    <div class="theme-switcher" id="themeSwitch">
        <i class="material-icons" id="themeIcon">dark_mode</i>
    </div>
</body>

</html>